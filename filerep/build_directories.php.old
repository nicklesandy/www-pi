<?php
/**
 *	Build directory tree
 *	
 */
 
set_time_limit(0);
ini_set('max_input_time', 99999);

include 'connection.php';
include 'act_settings.php';
include 'functions.php';




// TO REMOVE
// insert new (missing) directories
mysql_query("truncate table t_directory ", $conn);
mysql_query("
	insert into t_directory
	(
		id_share,
		relative_directory,
		active,
		size,
		date_last_modified,
		nbr_files,
		nbr_files_inactive
	) 
	select
		f.id_share,
		#replace(f.relative_directory, SUBSTRING_INDEX(f.relative_directory, '/', -1), '') as relative_directory,
		f.relative_directory,
		max(f.active) as active,
		sum(f.size) as size,
		max(f.date_last_modified) as date_last_modified,
		sum(case when f.active = 1 then 1 else 0 end) as nbr_files,
		sum(case when f.active = 0 then 1 else 0 end) as nbr_files_inactive
	from 
		t_file f
	#	left join t_directory d on d.relative_directory = replace(f.relative_directory, SUBSTRING_INDEX(f.relative_directory, '/', -1), '') and d.id_share = f.id_share 
	#where
	#	f.active = 1
	#	and d.id_directory is null
	group by
		f.id_share, 
		#replace(f.relative_directory, SUBSTRING_INDEX(f.relative_directory, '/', -1), '')
		f.relative_directory
	", $conn);

// TO REMOVE
// insert parent directories for orphaned directories (folders with only sub folders (i.e. no files) are not included)
mysql_query("
	insert into t_directory
	(
		id_share,
		relative_directory,
		active,
		size,
		date_last_modified,
		nbr_files,
		nbr_files_inactive
	) 
	select distinct
		d.id_share,
		replace(replace(d.relative_directory, SUBSTRING_INDEX(d.relative_directory, '/', -2), ''), '//', '/') as relative_directory,
		0 as active,
		0 as size,
		null as date_last_modified,
		0 as nbr_files,
		0 as nbr_files_inactive
	from 
		t_directory d
		left join t_directory dd on dd.relative_directory = replace(replace(d.relative_directory, SUBSTRING_INDEX(d.relative_directory, '/', -2), ''), '//', '/')
			and dd.id_share = d.id_share 
	where
		dd.id_directory is null
		
	", $conn);
	
	
// update dirname (take last part of directory structure)
mysql_query("
	update t_directory 
	set
		dirname = replace( SUBSTRING_INDEX(relative_directory, '/', -2), '/', '')
	where
		ifnull(dirname,'') = ''
		and relative_directory <> ''
		and relative_directory <> '/'
	", $conn);
	
	
// update directories
mysql_query("
	update t_directory d
	join (
		select
			f.id_share,
			#replace(f.relative_directory, SUBSTRING_INDEX(f.relative_directory, '/', -1), '') as relative_directory,
			f.relative_directory,
			max(f.active) as active,
			sum(f.size) as size,
			max(f.date_last_modified) as date_last_modified,
			sum(case when f.active = 1 then 1 else 0 end) as nbr_files,
			sum(case when f.active = 0 then 1 else 0 end) as nbr_files_inactive
		from 
			t_file f
		group by
			f.id_share,
			#replace(f.relative_directory, SUBSTRING_INDEX(f.relative_directory, '/', -1), '') 
			f.relative_directory
			
	) f on f.id_share = d.id_share
		and d.relative_directory = f.relative_directory
		#and f.active = 1
	set
		d.active = f.active,
		d.size = f.size,
		d.date_last_modified = f.date_last_modified,
		d.nbr_files = f.nbr_files,
		d.nbr_files_inactive = f.nbr_files_inactive
	
	", $conn);
	
// update parent directories 
mysql_query("
	
	update t_directory d
	join t_directory td on td.id_share = d.id_share
		and d.relative_directory <> td.relative_directory
		and replace(replace(d.relative_directory, SUBSTRING_INDEX(d.relative_directory, '/', -2), ''), '//', '/') = td.relative_directory
	set
		d.id_directory_parent = td.id_directory
		
	where
		d.id_directory_parent is null
		and ifnull(d.id_directory_parent,-1) <> td.id_directory
		
	", $conn);

// get max directory depth
$qry_max_depth = mysql_query("
	select
		max( ROUND (
			(
				LENGTH(d.relative_directory)
				- LENGTH( REPLACE ( d.relative_directory, '/', '') )
			) / LENGTH('/')
		) - 1 ) as max_depth
	from t_directory d
	where
		d.id_directory_parent is not null
	", $conn);

$max_depth = mysql_fetch_array($qry_max_depth)['max_depth'];

while($max_depth > 0){
	// update directory stats (size, dates)
	mysql_query("
		
		update t_directory d
		join (
			select
				dt.id_directory_parent,
				sum(ifnull(dt.size,0) + ifnull(dt.size_sub,0)) as size,
				max(dt.active) as active,
				max(dt.date_last_modified) as date_last_modified,
				sum(ifnull(dt.nbr_files,0) + ifnull(dt.nbr_files_sub,0)) as nbr_files,
				sum(ifnull(dt.nbr_files_inactive,0) + ifnull(dt.nbr_files_inactive_sub,0)) as nbr_files_inactive
			from t_directory dt
			where
				ROUND (
					(
						LENGTH(dt.relative_directory)
						- LENGTH( REPLACE ( dt.relative_directory, '/', '') )
					) / LENGTH('/')
				) - 1 = " . $max_depth . "
			group by 
				dt.id_directory_parent
			
			
		) dp  on dp.id_directory_parent = d.id_directory
		set
			d.size_sub = dp.size,
			
			d.active = dp.active,
			d.date_last_modified = dp.date_last_modified,
			
			d.nbr_files_sub = dp.nbr_files,
			d.nbr_files_inactive_sub = dp.nbr_files_inactive
		
		", $conn);
		
	$max_depth--;
}
?>