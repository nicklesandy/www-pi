<?php
/**
 *	Build file index
 *		For a complete run, first launch "build_fileindex_reset.php".
 *		This will reset the flag 'index_building' (settings) and clears all dates 'last replicated' on the server's shares
 *	Full run will take about 4h (for me, on a raspberry pi and a total of ~70.000 files (on an external usb drive))
 *	Incremental run takes about 6 minutes
 */
 
set_time_limit(0);
ini_set('max_input_time', 99999);

include 'connection.php';
include 'act_settings.php';
include 'functions.php';



// check if script is already running
//$check = mysql_fetch_array(mysql_query("select value from t_setting where code = 'index_building'", $conn));

// no, continue
//if($check['value'] == '0'){
//if($setting_index_building == '0')
{
	// mark as running
	mysql_query("update t_setting set value = '1' where code = 'index_building'", $conn);

	echo "Build index started on " . date('Y-m-d H:i:s', time()) . "'\n";
	
	flush();
	
	// insert new (missing) links between shares and server host
	$qry_missing_str = "
		from 
			t_host h
			join t_share s on 1=1
			left join t_host_share hs on hs.id_host = h.id_host and hs.id_share = s.id_share 
		where
			h.id_host = " . $setting_server_id_host . " 
			and s.active = 1
			and hs.id_host_share is null
		";
	$qry_missing = mysql_query("select h.id_host, s.id_share, s.server_directory, s.name " . $qry_missing_str, $conn);
	$qry_insert_missing = mysql_query("
		insert into t_host_share (id_host, id_share, local_directory) 
		select h.id_host, s.id_share, s.server_directory " .
		$qry_missing_str
		, $conn);
		
	while ($missing = mysql_fetch_array($qry_missing)) {
		echo "New share '" . $missing{'name'} . "' (" . $missing{'server_directory'} . ") added\n";
	}
	
	flush();
	
	$qry_shares = mysql_query("
		select
			s.id_share,
			s.name,
			s.info,
			s.server_directory,
			hs.id_host_share,
			hs.id_host,
			hs.local_directory,
			hs.date_linked_since,
			hs.date_last_replicated
		from t_share s
		join t_host_share hs on hs.id_share = s.id_share
			and hs.active = 1
			and hs.id_host = " . $setting_server_id_host . " 
		where
			s.active = 1
		order by s.id_share
		", $conn);
		

	$id_share = -1;

	while ($share = mysql_fetch_array($qry_shares)) {
		$id_share = $share{'id_share'};
		$dir = $share{'server_directory'};
		$date_last_replicated = $share{'date_last_replicated'};
		
		// make db timestamp into unix time
		$date_last_replicated = str_replace('-', '/', $date_last_replicated);
		$date_last_replicated = explode('.', $date_last_replicated)[0];
		$date_last_replicated = strtotime($date_last_replicated);
		
		if($date_last_replicated == '' || $date_last_replicated == null){
			$date_last_replicated = 0;
		}
		
		$date_start = time();
		
		
		echo "Share '" . $share{'name'} . "' (" . $share{'server_directory'} . ") (check since " . $share{'date_last_replicated'} . ")\n";
		echo " -> started on " . date('Y-m-d H:i:s', time()) . "'\n";
		//echo " -> modified since " . date('Y-m-d H:i:s', $date_last_replicated) . "'\n";
		//echo " -> modified since " . $share{'date_last_replicated'} . "'\n";
			
		flush();
		
		// clear current share index
		mysql_query("
			delete from t_file_index
			where
				id_share = " . $id_share . ",
				and id_host = " . $setting_server_id_host . " 
			", $conn);
		
		list_dir_shell_db($conn, $id_share, $setting_server_id_host, $dir);
		
		// update share stats
		mysql_query("
			update t_share
			set
				total_files = (select count(id_file) from t_file where id_share = " . $id_share . " and active = 1),
				total_filesize = (select sum(ifnull(size,0)) from t_file where id_share = " . $id_share . " and active = 1),
				date_last_modified = (select max(date_last_modified) from t_file where id_share = " . $id_share . " and active = 1),
				
				total_files_inactive = (select count(id_file) from t_file where id_share = " . $id_share . " and active = 0),
				total_filesize_inactive = (select sum(ifnull(size,0)) from t_file where id_share = " . $id_share . " and active = 0),
					
				hosts_linked = (select count(id_host_share) from t_host_share where id_share = " . $id_share . " and id_host <> " . $setting_server_id_host . " and active = 1),
				hosts_linked_inactive = (select count(id_host_share) from t_host_share where id_share = " . $id_share . " and id_host <> " . $setting_server_id_host . " and active = 0)
				
			where
				id_share = " . $id_share . "
			", $conn);
		
		// set date last replicated on share
		mysql_query("
			update t_host_share
			set
				date_last_replicated = '" . date('Y-m-d H:i:s', $date_start) . "'
			where
				active = 1
				and id_share = " . $id_share . "
				and id_host = " . $setting_server_id_host . " 
			", $conn);
		
		//echo "Share '" . $share{'name'} . "' done\n";
		echo " -> finished on " . date('Y-m-d H:i:s', time()) . "'\n";
	
		echo "\n";
		
	}
	
	// script is done, unmark as running
	mysql_query("update t_setting set value = '0' where code = 'index_building'", $conn);
	
}

?>